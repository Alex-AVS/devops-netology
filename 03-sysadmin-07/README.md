### 067 Компьютерные сети. Лекция 2
1. Список интерфейсов в linux можно посмотреть командой `ip link`:
   ```commandline
   vagrant@vagrant:~$ ip link
   1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN mode DEFAULT group default qlen 1000
       link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
   2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP mode DEFAULT group default qlen 1000
       link/ether 08:00:27:59:cb:31 brd ff:ff:ff:ff:ff:ff
   vagrant@vagrant:~$
   
   ```
   В windows - ipconfig:
   ```commandline
   E:\>ipconfig
   
   Windows IP Configuration
   
   
   Unknown adapter OpenVPN Wintun:
   
      Media State . . . . . . . . . . . : Media disconnected
      Connection-specific DNS Suffix  . :
   
   Ethernet adapter Ethernet:
   
      Connection-specific DNS Suffix  . :
      IPv4 Address. . . . . . . . . . . : 192.168.67.2
      Subnet Mask . . . . . . . . . . . : 255.255.255.0
      Default Gateway . . . . . . . . . : 192.168.67.1
   
   Ethernet adapter VirtualBox Host-Only Network:
   
      Connection-specific DNS Suffix  . :
      Link-local IPv6 Address . . . . . : fe80::4069:75a1:24a2:5892%8
      IPv4 Address. . . . . . . . . . . : 192.168.56.1
      Subnet Mask . . . . . . . . . . . : 255.255.255.0
      Default Gateway . . . . . . . . . :
   
   Unknown adapter OpenVPN TAP-Windows6:
   
      Media State . . . . . . . . . . . : Media disconnected
      Connection-specific DNS Suffix  . :
   
   ```
2. Для обнаружения соседей в сетях IPv4 обычно используется протокол LLDP (Link Layer Discovery Protocol).
Кроме того, существует ряд проприетарных протоколов, разработанных производителями оборудования. Такие как CDP (Cisco discovery protocol) или MDP (Mikrotik).
В linux для работы с LLDP используются утилиты из пакета `lldpd`.
3. Для разделения L2-коммутатора на несколько виртуальных сетей исполбзуются VLAN (Virtual Local Area Network).
В linux для работы с VLAN необходимо наличие в ядре модуля `8021q`. Работа с интерфейсами в современной системе обеспечивается командами утилиты `ip`. 
В Debian/Ubuntu для удобства конфигурирования необходим пакет `vlan`. 
В конфигурационнном файле `/etc/network/interfaces` интерфейсы именуются либо в виде префикс vlan + номер VLAN, либо в виде имя_родительского_интерфейса.vlanID.
Например, описание интерфейса может выглядеть так:
   ```shell
   auto eth0.10
   iface eth0.10 inet static
           address 10.0.1.1
           netmask 255.255.255.0
           vlan_raw_device eth0
   ```
4. Для агрегации интерфейсов в linux используются два способа - bonding и teaming. 
Их ключевое отличие в том, что первый работает полностью в пространстве ядра, второй же использует модули для предоставления специального интерфеса для демона teamd, который и выполняет всю работу.
Существует несколько режимов работы агрегации:
   - mode=0 (balance-rr)
   Этот режим используется по умолчанию, если в настройках не указано другое. 
   balance-rr обеспечивает балансировку нагрузки и отказоустойчивость.
   В данном режиме пакеты отправляются "по кругу" от первого интерфейса к последнему и сначала. 
   Если выходит из строя один из интерфейсов, пакеты отправляются на оставшиеся.
   
   - mode=1 (active-backup)
   При active-backup один интерфейс работает в активном режиме, остальные в ждущем.
   Если активный падает, управление передается одному из ожидающих. 
   Не требует поддержки данной функциональности от коммутатора.

   - mode=2 (balance-xor)
   Передача пакетов распределяется между объединенными интерфейсами по формуле ((MAC-адрес источника) XOR (MAC-адрес получателя)) % число интерфейсов.
   Один и тот же интерфейс работает с определённым получателем. 
   Режим даёт балансировку нагрузки и отказоустойчивость.

   - mode=3 (broadcast)
   Происходит передача во все объединенные интерфейсы, обеспечивая отказоустойчивость.

   - mode=4 (802.3ad)
   Динамическое объединение портов с использованием протокола LLDP или аналогичного. 
   В данном режиме можно получить значительное увеличение пропускной способности как входящего так и исходящего трафика, 
   используя все объединенные интерфейсы. Требует поддержки режима от коммутатора.

   - mode=5 (balance-tlb)
   Transmit load balancing - Балансировка исходящего трафика. 
   При balance-tlb входящий трафик получается только активным интерфейсом, исходящий - 
   распределяется в зависимости от текущей загрузки каждого интерфейса. 
   Обеспечивается отказоустойчивость. Не требует специальной поддержки коммутатора.

   - mode=6 (balance-alb)
   Адаптивная балансировка нагрузки. 
   Обеспечивает балансировку нагрузки как исходящего (TLB), так и входящего трафика. 
   Не требует специальной поддержки коммутатором.
   Балансировка входящего трафика достигается путём перехвата ARP переговоров. 
   Драйвер bonding перехватывает ARP ответы, отправляемые с локальных сетевых карт наружу, и переписывает MAC адрес источника на один из уникальных MAC адресов сетевой карты,
   участвующей в объединении. 
   Таким образом различные пиры используют различные MAC адреса сервера. 
   Балансировка входящего трафика распределяется последовательно (round-robin) между интерфейсами.
   Отказоустойчмвость ограниченная, т.к. при потере одного из интерфейсов требуется время на обновление arp-таблицы удалённого хоста.
   
   
   Для работы bonding требуется одноимённый модуль ядра. В Ubuntu ~~опять всё не как у людей~~ для управления требуется установить пакет `ifenslave`.
Настройка осуществляется в конфигурационном файле `/etc/network/interfaces`. 
Например, конфигурация для объединения двух интерфейсов `eth0` и `eth1` может быть примерно такой:
```shell
# основной интерфейс
auto bond0 eth0 eth1
# параметры бонд-интерфейса
iface bond0 inet static
        # адрес, маска, шлюз.
        address 10.0.0.11
        netmask 255.255.255.0
        gateway 10.0.0.254
        # подчиненные интерфейсы
        bond-slaves eth0 eth1
        # тип бондинга
        bond-mode balance-rr
        # интервал проверки линии в миллисекундах
        bond-miimon 100
        # гистерезис для исключения кратковременных сбоев:
        # задержка в миллисекундах с момента, как было обнаружено, что связь утеряна, до момента, как данный канал перестанет быть активным.
        bond-downdelay 200
        # задержка по включению.
        bond-updelay 200
```
   

5. В сети с маской /29 8 IP-адресов. Соответственно, сеть /24 можно разделить на 32 подсети с маской /29.
Например, 10.10.10.0/29, 10.10.10.8/29, 10.10.10.16/29 и т.д.
6. Судя по вебинару, предполагается, что нужно использовать диапазон CGNAT - 100.64.0.0/10.
Допустим, пусть у нас будет сеть 100.64.1.0/26. Это 64 адреса.
Следует отметить, что в реальной жизни использовать данный диапазон чревато, т.к. он используется провайдерами для выдачи "серых" IP клиентам. 
Уж лучше взять один из диапазонов Documentation, чем отправить свой внутренний трафик в Ростелеком.
7. Для просмотра arp-таблицы в linux используется команда `ip neigh show`, в windows - `arp -a`. 
Для очистки таблицы - команды `ip neigh flush` и `arp -d *` соответственно.
Для удаления конкретного хоста - `ip neigh del ADDR` и `arp -d ADDR`.